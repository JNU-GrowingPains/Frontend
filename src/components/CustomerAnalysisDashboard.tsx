import { useState } from 'react';
import { motion } from 'motion/react';
import { ArrowLeft, Users, DollarSign, Repeat, Crown, Clock, TrendingUp } from 'lucide-react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, ResponsiveContainer, Tooltip, LineChart, Line, PieChart, Pie, Cell, AreaChart, Area } from 'recharts';
import { Card } from './ui/card';
import { Button } from './ui/button';
import { Tabs, TabsContent, TabsList, TabsTrigger } from './ui/tabs';
import { useRouter } from './Router';
import { useLoyalCustomerKPI } from '../hooks/useDashboardData';
import { LoadingSpinner, ErrorMessage } from './ui/loading-spinner';
import { TimeRange } from '../services/api';

export function CustomerAnalysisDashboard() {
  const { navigate } = useRouter();
  const [selectedTab, setSelectedTab] = useState<TimeRange>('month');

  // API ÌõÖÎì§ ÏÇ¨Ïö©
  const { data: loyalCustomerKPI, loading: kpiLoading, error: kpiError } = useLoyalCustomerKPI(selectedTab);

  const handleBackClick = () => {
    navigate('/');
  };

  const handleTabChange = (value: string) => {
    setSelectedTab(value as TimeRange);
  };

  // VIP Í≥†Í∞ù Ï£ºÏöî ÌÜµÍ≥Ñ (ÎèôÏ†Å Í≥ÑÏÇ∞)
  const vipStats = [
    {
      icon: 'üë§',
      title: 'Ï∂©ÏÑ±Í≥†Í∞ù Ïàò',
      mainValue: loyalCustomerKPI.find((kpi: any) => kpi.title.includes('VIP Í≥†Í∞ùÏàò'))?.value || 'N/A',
      subValue: 'Ï¥ù Îß§Ï∂úÏï°',
      bgColor: 'rgba(0,0,0,0.05)'
    },
    {
      icon: 'üí∞',
      title: 'Ï¥ù Îß§Ï∂úÏï°',
      mainValue: loyalCustomerKPI.find((kpi: any) => kpi.title.includes('ÌèâÍ∑† LTV'))?.value || 'N/A',
      subValue: '5Ìöå',
      bgColor: 'rgba(0,0,0,0.05)'
    },
    {
      icon: '‚è≥',
      title: 'ÌèâÍ∑† Ïû¨Íµ¨Îß§ Í∏∞Í∞Ñ',
      mainValue: loyalCustomerKPI.find((kpi: any) => kpi.title.includes('ÌèâÍ∑† Íµ¨Îß§ Í∞ÑÍ≤©'))?.value || 'N/A',
      subValue: '10/10/2023',
      bgColor: 'rgba(0,0,0,0.05)'
    }
  ];

  // Mock Ï∞®Ìä∏ Îç∞Ïù¥ÌÑ∞Îì§ (ÏãúÍ∞Ñ Î≤îÏúÑÏóê Îî∞Îùº ÎèôÏ†ÅÏúºÎ°ú Ï°∞Ï†ï)
  const getRepurchaseTimeData = () => {
    const baseData = [
      { time: '1-7Ïùº', count: 45 },
      { time: '8-14Ïùº', count: 32 },
      { time: '15-21Ïùº', count: 28 },
      { time: '22-28Ïùº', count: 35 },
      { time: '29-35Ïùº', count: 42 },
      { time: '36-42Ïùº', count: 38 },
      { time: '43Ïùº+', count: 25 }
    ];

    const multiplier = selectedTab === 'yesterday' ? 0.05 : selectedTab === 'week' ? 0.3 : 1;
    return baseData.map(item => ({
      ...item,
      count: Math.round(item.count * multiplier)
    }));
  };

  const deviceData = [
    { name: 'Mobile', value: 45, color: 'rgba(0,0,0,0.5)' },
    { name: 'PC', value: 35, color: 'rgba(0,0,0,0.3)' },
    { name: 'Tablet', value: 20, color: 'rgba(0,0,0,0.1)' }
  ];

  const categoryData = [
    { category: 'ÏÉÅÏùò', value: 310, color: '#03045e' },
    { category: 'ÌïòÏùò', value: 280, color: '#023e8a' },
    { category: 'ÏïÑÏö∞ÌÑ∞', value: 251, color: '#0077b6' },
    { category: 'Ïã†Î∞ú', value: 224, color: '#0096c7' },
    { category: 'Í∞ÄÎ∞©', value: 195, color: '#00b4d8' },
    { category: 'Ïï°ÏÑ∏ÏÑúÎ¶¨', value: 187, color: '#48cae4' },
    { category: 'Ïñ∏ÎçîÏõ®Ïñ¥', value: 133, color: '#8aebff' },
    { category: 'Í∏∞ÌÉÄ', value: 101, color: '#caf0f8' }
  ];

  const accessPageData = [
    { page: 'Î©îÏù∏ ÌéòÏù¥ÏßÄ', value: 310, color: '#03045e' },
    { page: 'ÏÉÅÌíà ÏÉÅÏÑ∏', value: 280, color: '#023e8a' },
    { page: 'Ïπ¥ÌÖåÍ≥†Î¶¨', value: 251, color: '#0077b6' },
    { page: 'Ïû•Î∞îÍµ¨Îãà', value: 224, color: '#0096c7' },
    { page: 'ÎßàÏù¥ÌéòÏù¥ÏßÄ', value: 195, color: '#00b4d8' },
    { page: 'Ïù¥Î≤§Ìä∏', value: 187, color: '#48cae4' },
    { page: 'Î¶¨Î∑∞', value: 133, color: '#8aebff' },
    { page: 'Í∏∞ÌÉÄ', value: 101, color: '#caf0f8' }
  ];

  const getLoyaltyFlowData = () => {
    const baseData = [
      { period: '1Ïõî', repurchaseRate: 25.2, avgLTV: 750000, vipContribution: 60 },
      { period: '2Ïõî', repurchaseRate: 26.1, avgLTV: 765000, vipContribution: 62 },
      { period: '3Ïõî', repurchaseRate: 24.8, avgLTV: 720000, vipContribution: 58 },
      { period: '4Ïõî', repurchaseRate: 27.3, avgLTV: 780000, vipContribution: 63 },
      { period: '5Ïõî', repurchaseRate: 28.1, avgLTV: 810000, vipContribution: 64 },
      { period: '6Ïõî', repurchaseRate: 28.5, avgLTV: 820000, vipContribution: 65 },
      { period: '7Ïõî', repurchaseRate: 29.2, avgLTV: 840000, vipContribution: 67 }
    ];

    if (selectedTab === 'yesterday') {
      return [{ period: 'Ïñ¥Ï†ú', repurchaseRate: 29.5, avgLTV: 850000, vipContribution: 68 }];
    } else if (selectedTab === 'week') {
      return [
        { period: 'Ïõî', repurchaseRate: 28.5, avgLTV: 820000, vipContribution: 65 },
        { period: 'Ìôî', repurchaseRate: 29.1, avgLTV: 830000, vipContribution: 66 },
        { period: 'Ïàò', repurchaseRate: 28.8, avgLTV: 825000, vipContribution: 65 },
        { period: 'Î™©', repurchaseRate: 29.4, avgLTV: 840000, vipContribution: 67 },
        { period: 'Í∏à', repurchaseRate: 30.2, avgLTV: 860000, vipContribution: 69 },
        { period: 'ÌÜ†', repurchaseRate: 27.9, avgLTV: 800000, vipContribution: 63 },
        { period: 'Ïùº', repurchaseRate: 26.5, avgLTV: 780000, vipContribution: 61 }
      ];
    }

    return baseData;
  };

  // Î°úÎî© ÏÉÅÌÉú ÌôïÏù∏
  const isLoading = kpiLoading;
  const hasError = kpiError;

  if (hasError) {
    return <ErrorMessage message={hasError} />;
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <motion.header
        initial={{ y: -50, opacity: 0 }}
        animate={{ y: 0, opacity: 1 }}
        transition={{ duration: 0.6 }}
        className="bg-white border-b border-gray-200 px-8 py-6"
      >
        <div className="flex items-center justify-between">
          <Button
            variant="ghost"
            size="sm"
            onClick={handleBackClick}
            className="flex items-center space-x-2"
          >
            <ArrowLeft className="w-4 h-4" />
            <span>ÎèåÏïÑÍ∞ÄÍ∏∞</span>
          </Button>
          
          <motion.h1 
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            transition={{ duration: 0.6, delay: 0.1 }}
            className="text-2xl font-bold text-gray-900"
          >
            Ï£ºÏöî Í≥†Í∞ù ÏßëÏ§ë Î∂ÑÏÑù
          </motion.h1>
          
          <div></div>
        </div>
      </motion.header>

      <div className="p-8 space-y-12">
        {isLoading ? (
          <LoadingSpinner />
        ) : (
          <>
            {/* Ï∂©ÏÑ± Í≥†Í∞ù Î∂ÑÏÑù */}
            <motion.section
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.6, delay: 0.2 }}
              className="text-center space-y-6"
            >
              <h2 className="text-4xl font-bold text-gray-900">Ï∂©ÏÑ± Í≥†Í∞ù Î∂ÑÏÑù</h2>
              
              <Tabs value={selectedTab} onValueChange={handleTabChange}>
                <TabsList className="grid w-fit grid-cols-3 mx-auto">
                  <TabsTrigger value="yesterday">Ïñ¥Ï†ú</TabsTrigger>
                  <TabsTrigger value="week">Ïù¥Î≤àÏ£º</TabsTrigger>
                  <TabsTrigger value="month">Ïù¥Î≤àÎã¨</TabsTrigger>
                </TabsList>
              </Tabs>
            </motion.section>

            {/* Ï∂©ÏÑ±Í≥†Í∞ù KPI */}
            <motion.section
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.6, delay: 0.3 }}
              className="space-y-8"
            >
              <h2 className="text-4xl font-bold text-gray-900 text-center">Ï∂©ÏÑ±Í≥†Í∞ù KPI</h2>
              
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                {loyalCustomerKPI.map((kpi: any, index: number) => (
                  <motion.div
                    key={kpi.title}
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ duration: 0.6, delay: 0.4 + index * 0.1 }}
                  >
                    <Card className="p-4 hover:shadow-lg transition-shadow h-[124px]">
                      <div className="space-y-1">
                        <p className="text-sm text-gray-500">{kpi.title}</p>
                        <p className="text-2xl font-medium text-gray-900">{kpi.value}</p>
                        {kpi.change && (
                          <p className={`text-sm ${
                            kpi.changeType === 'positive' ? 'text-green-600' : 'text-red-600'
                          }`}>
                            {kpi.change}
                          </p>
                        )}
                      </div>
                    </Card>
                  </motion.div>
                ))}
              </div>
            </motion.section>

            {/* VIP Í≥†Í∞ù Ï£ºÏöî ÌÜµÍ≥Ñ */}
            <motion.section
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.6, delay: 0.5 }}
              className="space-y-8"
            >
              <h2 className="text-4xl font-bold text-gray-900 text-center">VIP Í≥†Í∞ù Ï£ºÏöî ÌÜµÍ≥Ñ</h2>
              
              <div className="grid grid-cols-1 md:grid-cols-3 gap-10">
                {vipStats.map((stat, index) => (
                  <motion.div
                    key={stat.title}
                    initial={{ opacity: 0, y: 20 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ duration: 0.6, delay: 0.6 + index * 0.1 }}
                    className="text-center space-y-5"
                  >
                    <div 
                      className="w-[100px] h-[100px] rounded-full mx-auto flex items-center justify-center text-5xl"
                      style={{ backgroundColor: stat.bgColor }}
                    >
                      {stat.icon}
                    </div>
                    <div className="space-y-2">
                      <p className="text-xl text-gray-900">{stat.mainValue}</p>
                      <p className="text-base text-gray-500">{stat.subValue}</p>
                    </div>
                    <h3 className="text-2xl font-medium text-gray-900">{stat.title}</h3>
                  </motion.div>
                ))}
              </div>
            </motion.section>

            {/* Î∂ÑÏÑù Ï∞®Ìä∏ */}
            <motion.section
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.6, delay: 0.7 }}
              className="space-y-8"
            >
              <h2 className="text-4xl font-bold text-gray-900 text-center">Î∂ÑÏÑù Ï∞®Ìä∏</h2>
              
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-10 mb-10">
                {/* Ïû¨ÔøΩÔøΩÎß§ ÏãúÍ∞Ñ Î∂ÑÏÑù */}
                <Card className="p-6">
                  <div className="space-y-3 mb-6">
                    <h3 className="text-xl font-medium text-gray-900">Ïû¨Íµ¨Îß§ ÏãúÍ∞Ñ ÎåÄ</h3>
                    <p className="text-base text-gray-500">Ïàò</p>
                  </div>
                  <div className="h-[280px] mb-4">
                    <ResponsiveContainer width="100%" height="100%">
                      <AreaChart data={getRepurchaseTimeData()}>
                        <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                        <XAxis dataKey="time" stroke="#6b7280" fontSize={12} />
                        <YAxis stroke="#6b7280" fontSize={12} />
                        <Tooltip 
                          contentStyle={{ 
                            backgroundColor: 'white', 
                            border: '1px solid #e5e7eb', 
                            borderRadius: '8px'
                          }}
                        />
                        <Area 
                          type="monotone" 
                          dataKey="count" 
                          stroke="rgba(0,0,0,0.8)" 
                          fill="url(#gradient)" 
                          strokeWidth={2}
                        />
                        <defs>
                          <linearGradient id="gradient" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="5%" stopColor="rgba(0,0,0,0.2)" />
                            <stop offset="95%" stopColor="rgba(0,0,0,0)" />
                          </linearGradient>
                        </defs>
                      </AreaChart>
                    </ResponsiveContainer>
                  </div>
                  <p className="text-base text-gray-500 text-right">ÏãúÍ∞Ñ???</p>
                </Card>

                {/* Ï£ºÏöî Ï†ëÏÜç ÎîîÎ∞îÏù¥Ïä§ */}
                <Card className="p-6">
                  <div className="space-y-3 mb-6">
                    <h3 className="text-xl font-medium text-gray-900">Ï£ºÏöî Ï†ëÏÜç ÎîîÎ∞îÏù¥Ïä§</h3>
                    <p className="text-base text-gray-500">???</p>
                  </div>
                  <div className="h-[280px] mb-4">
                    <ResponsiveContainer width="100%" height="100%">
                      <PieChart>
                        <Pie
                          data={deviceData}
                          cx="50%"
                          cy="50%"
                          innerRadius={60}
                          outerRadius={120}
                          paddingAngle={2}
                          dataKey="value"
                        >
                          {deviceData.map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={entry.color} />
                          ))}
                        </Pie>
                        <Tooltip formatter={(value) => [`${value}%`, 'ÎπÑÏú®']} />
                      </PieChart>
                    </ResponsiveContainer>
                  </div>
                  <p className="text-base text-gray-500 text-right">ÎπÑÏú®???</p>
                </Card>
              </div>

              <div className="grid grid-cols-1 lg:grid-cols-2 gap-10">
                {/* Ï∂©ÏÑ±Í≥†Í∞ù ÏÑ†Ìò∏ Ïπ¥ÌÖåÍ≥†Î¶¨ */}
                <Card className="p-6">
                  <div className="space-y-3 mb-6">
                    <div className="flex justify-between items-center">
                      <h3 className="text-base font-normal text-gray-900">Ï∂©ÏÑ±Í≥†Í∞ù ÏÑ†Ìò∏ Ïπ¥ÌÖåÍ≥†Î¶¨</h3>
                      <p className="text-base text-gray-400">8Í∞ú Ïπ¥ÌÖåÍ≥†Î¶¨</p>
                    </div>
                  </div>
                  <div className="space-y-0">
                    {categoryData.map((item, index) => (
                      <div
                        key={item.category}
                        className="flex items-center py-2.5 px-4 text-white text-base font-medium"
                        style={{
                          backgroundColor: item.color,
                          width: `${(item.value / 310) * 100}%`,
                          borderRadius: index === 0 ? '6px 6px 0 0' : index === categoryData.length - 1 ? '0 0 6px 6px' : '0 6px 6px 0'
                        }}
                      >
                        {item.category}
                      </div>
                    ))}
                  </div>
                </Card>

                {/* Ï∂©ÏÑ±Í≥†Í∞ù Ï£ºÏöî Ï†ëÏÜç ÌéòÏù¥ÏßÄ */}
                <Card className="p-6">
                  <div className="space-y-3 mb-6">
                    <h3 className="text-xl font-medium text-gray-900">Ï∂©ÏÑ±Í≥†Í∞ù Ï£ºÏöî Ï†ëÏÜç ÌéòÏù¥ÏßÄ</h3>
                    <p className="text-base text-gray-500">Îß§Ï∂ú ÎπÑÏú®(%)</p>
                  </div>
                  <div className="space-y-0">
                    {accessPageData.map((item, index) => (
                      <div
                        key={item.page}
                        className="flex items-center py-2.5 px-4 text-white text-base font-medium"
                        style={{
                          backgroundColor: item.color,
                          width: `${(item.value / 310) * 100}%`,
                          borderRadius: index === 0 ? '6px 6px 0 0' : index === accessPageData.length - 1 ? '0 0 6px 6px' : '0 6px 6px 0'
                        }}
                      >
                        {item.page}
                      </div>
                    ))}
                  </div>
                </Card>
              </div>
            </motion.section>

            {/* Ï∂©ÏÑ±ÎèÑ ÌùêÎ¶Ñ */}
            <motion.section
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ duration: 0.6, delay: 0.8 }}
              className="space-y-8"
            >
              <h2 className="text-4xl font-bold text-gray-900 text-center">Ï∂©ÏÑ±ÎèÑ ÌùêÎ¶Ñ</h2>
              
              <Card className="p-6">
                <div className="space-y-3 mb-6">
                  <h3 className="text-xl font-medium text-gray-900">Ï∂©ÏÑ± Í≥†Í∞ù Ïú†ÏßÄ</h3>
                  <p className="text-base text-gray-500">Ïû¨Íµ¨Îß§Ïú®, ÌèâÍ∑† LTV, VIP Îß§Ï∂ú Í∏∞Ïó¨ÎèÑ</p>
                </div>
                <div className="h-[280px] mb-4">
                  <ResponsiveContainer width="100%" height="100%">
                    <AreaChart data={getLoyaltyFlowData()}>
                      <CartesianGrid strokeDasharray="3 3" stroke="#f0f0f0" />
                      <XAxis dataKey="period" stroke="#6b7280" fontSize={12} />
                      <YAxis stroke="#6b7280" fontSize={12} />
                      <Tooltip 
                        contentStyle={{ 
                          backgroundColor: 'white', 
                          border: '1px solid #e5e7eb', 
                          borderRadius: '8px'
                        }}
                      />
                      <Area 
                        type="monotone" 
                        dataKey="repurchaseRate" 
                        stroke="rgba(0,0,0,0.8)" 
                        fill="url(#loyaltyGradient)" 
                        strokeWidth={2}
                      />
                      <defs>
                        <linearGradient id="loyaltyGradient" x1="0" y1="0" x2="0" y2="1">
                          <stop offset="5%" stopColor="rgba(0,0,0,0.2)" />
                          <stop offset="95%" stopColor="rgba(0,0,0,0)" />
                        </linearGradient>
                      </defs>
                    </AreaChart>
                  </ResponsiveContainer>
                </div>
                <p className="text-base text-gray-500 text-right">???</p>
              </Card>
            </motion.section>
          </>
        )}
      </div>
    </div>
  );
}